<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chat Mmodule Tesgt</title>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="chat.css">
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <script>
var ws = new WebSocket("ws://172.17.0.42:8080/");
ws.onmessage = function(evt) {
       	console.log($.parseJSON(evt.data));
       	var jObj = $.parseJSON(evt.data);
       	if (!jObj.commandSet) {
       		console.log("Missing commandSet");
       		return;
       	}
       	if (jObj.commandSet == "chat") {
       		if (jObj.command == "sendMessage") {
       			jObj = jObj.sendMessage;
       			var User = jObj.user;
       			var Text = jObj.msg;
       			var Channel = '#' + jObj.chat + '_ChatBox';
       			var msgDiv = "<div class='cMsg'><span class='cMsgUser'>" + User + "</span><span class='cMsgMsg'>" + Text + "</span></div>";
       			$(Channel).append(msgDiv);
       			console.log("Append to " + Channel);
       		}
       		else if (jObj.command == "userJoin") {
       			jObj = jObj.userJoin;
       			var User = jObj.user;
       			var Channel = '#' + jObj.chat + '_UserBox';
       			var msgDiv = "<div class='cUser' chatUser='" + User + "'>" + User + "</div>";
       			$(Channel + " .cUser").each(function() {
       					if ($(this).attr('chatUser') == User) return;
       			});
       			$(Channel).append(msgDiv);
       		}
       		else if (jObj.command == "userList") {
       			jObj = jObj.userList;
       			var userList = jObj.list;
       			var Channel = '#' + jObj.chat + '_UserBox';
       			for (val of userList) {
       				var User = val;
       				var msgDiv = "<div class='cUser' chatUser='" + User + "'>" + User + "</div>";
       				var userExists = false;
       				$(Channel + " div").each(function() {
       						if ($(this).attr('chatUser') == User) {
       							console.log("User already exists in userBox");
       							userExists = true;
       						}
       				});
     				if (!userExists) $(Channel).append(msgDiv);
       			}
       			
       		}
       	}
       	else {
       		console.log("Received non-chat command: " + jObj.commandSet);
       	}
       		
 };
ws.onclose = function() {};
ws.onopen = function() { };
  $(document).ready(function() {

    $("#chatTabs").tabs();
    $("#chatTabs").tabs().css({
      'height': '400px',
      'overflow': 'auto'
    });
    $("#chatTabs").tabs().on("show", function() {
      $(this).children("div").height($(this).parent().height());
    });
    $("#chatTabs").delegate("span.ui-icon-close", "click", function() {
      var panelId = $(this).closest("li").remove().attr("aria-controls");
      $("#" + panelId).remove();
      $("#chatTabs").tabs("refresh");
    });
    $(document).delegate(".cInputBox", "keypress", function(ev) {
      var keycode = (ev.keyCode ? ev.keyCode : ev.which);
      console.log("Delegate keypress!");
      if (keycode == '13') {
        statusJSON = {
          "commandSet": "chat",
          "chatCommand": "sendMessage",
          "chatTarget": $(this).attr("chatRoom"),
          "sendMessage": {
            "msg": $(this).val(),
          },
        };
        ws.send(JSON.stringify(statusJSON));
        console.log("Pressed enter, we should send something over the non-existent websocket for this");
        console.log("Origin was " + $(this).attr("chatRoom") + " I think");
        $(this).val('');
      }
    });
    //    $("#add-tab").click(function() {
    $("#joinChannel").submit(function(event) {
      event.preventDefault();

      var num_chatTabs = $("#chatTabs ul li").length + 1;
      var tabName = "chatTab" + num_chatTabs;
      tabName = $("#joinChannel input").val();
      if ($("#" + tabName).length) {
        console.log("We already have this tab open!")
        return;
      }
      console.log(tabName);
      console.log($("#joinChannel"));
      console.log($("#joinChannel input"));
      console.log("Setting tabName to " + tabName + " instead");

      $("#chatTabs ul").append(
        "<li><a href='#" + tabName + "'>" + tabName + "</a><span class='ui-icon ui-icon-close' role='presentation'>Remove Tab</span></li>"
      );
      $("#chatTabs").append("<div class='AriaTab' id='" + tabName + "'></div>")
      var MyObject = [{
        'tabName': tabName,
      }, ]
      $.ajax({
        url: "/carbide/client/chatRoom/createDiv.php",
        type: 'post',
        data: {
          jsonSend: JSON.stringify(MyObject),
        },
        datatype: 'json',
        success: function(data) {
          console.log(data);
          var result = JSON.parse(data);
          if (result.success === false) {
            console.log(result['failReasons']);
            $("#" + tabName + " .ui-icon-close").click();
            return;
          }
          if (result.html) {
            var html_result = result.html;
            console.log(html_result);
            $("#" + tabName).html(html_result);
          }
          if (result.script) {
            console.log("Script receieved!");
            eval(result.script);
          }
          var statusJSON = {
            "commandSet": "chat",
            "chatCommand": "joinChannel",
            "chatTarget": tabName,
            "joinChannel": {
              "chatTarget": tabName,
            },
          };
          ws.send(JSON.stringify(statusJSON));
					var rval = ws.send(JSON.stringify(statusJSON));
					console.log("Informing server we are joining the channel !!! Return val from ws was: " + rval);
					console.log(ws);
          console.log(statusJSON);
        },
        error: function(data, error, xqhr) {
          $("#" + tabName + " .ui-icon-close").click();
        },
      });
      $("#chatTabs").tabs("refresh");
    });
  });
  
</script>
</head>
<body>

<form id="joinChannel" action="">
	<label for="cname">Channel Name</label>
	<input type="text" name="cname">
	<input type="submit" value="Join">
</form>
<div id="chatTabs">
<ul></ul>
</div>
 
 
</body>
</html>